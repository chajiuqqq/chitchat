name: Docker Build and Push
on:
  push:
    branches:
      - "micro"
  workflow_dispatch:
jobs:
  build-and-push:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - # Setting up Docker Buildx with docker-container driver is required
        # at the moment to be able to use a subdirectory with Git context
        name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2
      - name: Build Docker images
        run: |
          TAG=$(git describe --tags --abbrev=0)
          docker-compose build --build-arg TAG=${TAG}
      - name: Push Docker images
        env:
          DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
          DOCKER_PASSWORD: ${{ secrets.DOCKER_PASSWORD }}
        run: |
          REGISTRY_USERNAME="${DOCKER_USERNAME}"
          REGISTRY_PASSWORD="${DOCKER_PASSWORD}"
          IMAGE_NAMES=(
            "chitchat_frontend"
            "chitchat_threadservice"
            "chitchat_authservice"
          )
          for IMAGE_NAME in "${IMAGE_NAMES[@]}"; do
            docker login -u "${REGISTRY_USERNAME}" -p "${REGISTRY_PASSWORD}"
            docker push "${IMAGE_NAME}:${TAG}"
          done
